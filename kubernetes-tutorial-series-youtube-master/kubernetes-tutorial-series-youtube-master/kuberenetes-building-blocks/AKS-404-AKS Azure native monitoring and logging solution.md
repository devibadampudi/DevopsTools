
# AKS Azure native monitoring and logging solution

## Table of Contents

[Overview](#overview)

[Pre-Requisites](#Pre-requisites)

[Accessing the AKS cluster](#accessing-the-aks-cluster)

[Kubernetes RBAC Authorization](#kubernetes-rbac-authorization)

[Azure Native Monitoring and Logging Solution](#azure-native-monitoring-and-logging-solution)

[Search Logs to Analyze Data](#search-logs-to-analyze-data)

## Overview

In this lab you'll learn about Azure native monitoring and logging. **Azure Monitor** for containers includes a feature, which is currently in preview, that provides a live view into your Azure Kubernetes Service (AKS) container logs (stdout/stderr) and events without having to run kubectl commands. When you select either option, a new pane appears below the performance data table on the **Nodes,** **Controllers,** and **Containers** view. It shows live logging and events generated by the container engine to further assist in troubleshooting issues in real time.

##  Pre-Requisites

1. Azure Cloud Infrastructure account credentials (User, Password, ResourceGroup, and Subscription).
2. Basic Linux Commands.
3. Docker Fundamentals.
4. Basic Azure Cloud Knowledge.

## Accessing the AKS cluster

**Sign in to Azure portal**

1.	Using the Chrome browser provided in the Qloudable Console on the right, sign into Azure portal using the following credentials generated for you:

* **Azure Login ID :** {{azure_login}}

* **Azure Password :** {{azure_password}}

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/landingpage.PNG?st=2019-10-16T09%3A58%3A17Z&se=2022-10-17T09%3A58%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=CUJ%2B2tK4s25F%2BL88voMTtzpAM8obbAYafLnFYsuYOzc%3D" alt="image-alt-text">

2. Navigate to the `resource-groups` you should see a two resource groups deployed one contains aks-cluster resource, The second resource group, known as the node resource group, contains all of the infrastructure resources associated with the cluster. These resources include the Kubernetes node VMs, virtual networking, and storage. By default, the node resource group has a name like MC_myResourceGroup_myAKSCluster_eastus. AKS automatically deletes the node resource whenever the cluster is deleted, so it should only be used for resources which share the cluster's lifecycle.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/resource-group.png?st=2019-10-16T10%3A11%3A16Z&se=2022-10-17T10%3A11%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=%2FZ9OfMLVZesJZ%2FWe5PN5Y1cTlpJnZB9HKcM9%2B7k%2F6AI%3D" alt="image-alt-text">

3. Click Apps icon in the toolbar and select Powershell to open a terminal window.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20EKS/e1.png?st=2019-10-16T10%3A37%3A05Z&se=2022-10-17T10%3A37%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=ovJqaeJVkF09fPiC9U3qAw%2Bjgya3oWbPwDeFToeaGQY%3D" alt="image-alt-text">

4. First need to login with azure credentials in the powershell, using the following command.

`az login -u {{azure_login}} -p {{azure_password}}`

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/azure-login-using-powershell.PNG?st=2019-10-16T09%3A58%3A53Z&se=2022-10-17T09%3A58%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=%2B0dby1%2FJoiIcxWUdb2QmbnQy%2BGed%2FX5ZNso2dKRPIJ0%3D" alt="image-alt-text">

5. Needs to run access cluster command for kubeconfig file.

`az aks get-credentials --resource-group {{rg-name}} --name {{cluster-name}} --admin`

6. We have initialized the environment, Get the all node using `kubectl get nodes` command to list-out nodes in a k8's cluster.

`kubectl get nodes`

```
NAME                        STATUS    ROLES     AGE       VERSION
aks-agentnodepool-24439688   Ready    agent     14m       V1.13.10

```

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/getnodes.PNG?st=2019-10-16T10%3A03%3A13Z&se=2022-10-17T10%3A03%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=4B0%2B6n1ewyUtcRESuvc3PyYZtprWPe%2FRWtj7%2BwHWchA%3D" alt="image-alt-text">

5. using this command you get the default namespaces `kubectl get ns`

```bash
kubectl get ns
```

```
NAME          STATUS    AGE
default       Active    8m
kube-public   Active    8m
kube-system   Active    8m

```

## Kubernetes RBAC Authorization

If you have enabled Kubernetes RBAC authorization, you will need to apply cluster role binding. The following example steps demonstrate how to configure cluster role binding from this yaml configuration template.

``` yaml

apiVersion: rbac.authorization.k8s.io/v1 
kind: ClusterRole 
metadata: 
   name: containerHealth-log-reader 
rules: 
   - apiGroups: [""] 
     resources: ["pods/log", "events"] 
     verbs: ["get", "list"]  
--- 
apiVersion: rbac.authorization.k8s.io/v1 
kind: ClusterRoleBinding 
metadata: 
   name: containerHealth-read-logs-global 
roleRef: 
    kind: ClusterRole 
    name: containerHealth-log-reader 
    apiGroup: rbac.authorization.k8s.io 
subjects: 
   - kind: User 
     name: clusterUser 
     apiGroup: rbac.authorization.k8s.io
```



If you are configuring it for the first time, you can apply the cluster role binding by using `kubectl create -f <filename>`. 


PS C:\Users\Sysgain> kubectl create -f E:\clusterrole.yaml

clusterrole.rbac.authorization.k8s.io "containerHealth-log-reader" created

Azure native monitoring and logging solution


## Azure Native Monitoring and Logging Solution

Navigate to the `resource-groups` you should see a two resource groups deployed one contains aks-cluster resource,Click the created Kubernetes service and go to the insights.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m1.png?st=2019-10-30T07%3A02%3A07Z&se=2022-10-31T07%3A02%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=E9DuJVmJPl94UkCw%2BTUABEh6cjn15G1FYIyVa4%2BF4ew%3D" alt="image-alt-text">

Click **Monitor containers** to get health and performance insights.


**The performance chart displays four performance metrics:**

•**Node CPU Utilization %:** An aggregated perspective of CPU utilization for the entire cluster. You can filter the results for the time range by selecting Avg, Min, Max, 50th, 90th, and 95th in the percentiles selector above the chart, either individually or combined.

•**Node memory utilization %:** An aggregated perspective of memory utilization for the entire cluster. You can filter the results for the time range by selecting Avg, Min, Max, 50th, 90th, and 95th in the percentiles selector above the chart, either individually or combined.

•**Node count:** A node count and status from Kubernetes. Statuses of the cluster nodes represented are All, Ready, and Not Ready and can be filtered individually or combined in the selector above the chart.

•**Activity pod count:** A pod count and status from Kubernetes. Statuses of the pods represented are All, Pending, Running, and Unknown and can be filtered individually or combined in the selector above the chart.


<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m2.png?st=2019-10-30T07%3A02%3A38Z&se=2022-10-31T07%3A02%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=U5uxsOaQeKdtpTDSYZzwv81h8e2%2BWAkQ7Ty%2FIULV8oA%3D" alt="image-alt-text">

### Create a Pod

1. Pod manifests can be written using YAML or JSON, but YAML is usually preferred because it is easier to edit, and comments can be added where necessary. In our labs we will use YAML files, which are text files with extensions .yml or .yaml.

2. Pod manifests include a few key fields and attributes. Below, YAML is used to create the pod.

Those key fields and attributes include:

   * The metadata section for describing the pod's name and its namespace.
   * A spec section for describing volumes, images, container port, imagepullsecrets and much more. 
   * A list of containers that will run in the Pod.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/pod.png?st=2019-08-26T08%3A22%3A53Z&se=2022-08-27T08%3A22%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=O9UjF8Vg%2F4k78Jb7SlJ1ICiTkUSV1lCYSLBwlIIflT0%3D" alt="image-alt-text" >

3. Save the following pod YAML file with a filename extension (e.g. '.yml'), open a Notepad copy configuration of the pod, then paste and save it in a file (e.g. 'devteam-pod.yml'). Please make sure "All Files" is selected for the "Save as Type" option.

``` yaml
apiVersion: v1
kind: Pod
metadata:
  name: http-service
  namespace: devteam
  labels:
    run: my-nginx
spec:
  containers:
  - name: my-nginx
    image: nginx
    ports:
    - containerPort: 80
```

4. Choose the correct path of configuration for the yaml file, while deploys into the cluster.

```bash
kubectl create -f <file path>
```


 ```bash
 kubectl create -f /c/Users/PhotonUser/Desktop/devteam-pod.yml
  ```
 * This is a simple pod that deploys an nginx image of the latest version and exposes port 80. This pod is created in the devteam namespace with the podname 'http-service' and container name 'my-nginx'.

5. The pod manifest will be submitted to the Kubernetes API server.

6. The Kubernetes system will then schedule that pod to run on a healthy node in the cluster, where it will be monitored by the kubelet daemon process.

### Get the Pods

1. List out the pods running in a namespace, by using the following command;

  E.g: `kubectl -n <namespace-name> get pods`

  `kubectl -n devteam get pods`

  ```
  NAME      READY     STATUS    RESTARTS   AGE
  http-service   1/1       Running   0          4m
  ```

2.You can see the name of pod ('http-service') that was provided in the previous YAML file. In addition to the number of ready containers, the output also shows the status, the number of times the pod was restarted, as well as the age of the pod.

### Running Commands in a Container with exec

1. Execute the commands in the conditions of container itself. Get an interactive session by adding the `-it` flag.

**Note** If you are using gitbash, use `winpty` in front of kubectl command

```bash
kubectl -n devteam exec -it http-service bash
Unable to use a TTY - input is not a terminal or the right kind of file
```

```
winpty kubectl -n devteam exec -it http-service bash

root@http-service:/#
```

2. If you want to install packages or resources like (e.g. curl) inside a pod, use the following commands. 

```bash
root@testpod:/# apt-get update
```
```bash
root@testpod:/# apt-get install curl
```
```bash
root@testpod:/# curl localhost:80
```
  
  * You should see the following output, if nginx is running.
  
```
  root@http-service:/# curl localhost:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>  
```
  
* Type `exit` to getout of the pod and recover the command-line

```bash
  root@testpod:/# exit
```
  
 ### Logs of the pod
 
1. Open a separate git-bash window access the nginx logs by using the following command. Kubectl logs command downloads the current logs from the running instance. Adding `-f` flag will allow to continuously stream logs.

  `kubectl -n devteam logs -f http-service`
  
2. In the first git-bash window (make sure you are still inside the pod, if not  run `winpty kubectl -n devteam exec -it http-service bash`) `curl localhost:80` watch log lines have been added to second git-bash window.

 ```bash
 kubectl -n devteam logs -f http-service
 ```
 
```
127.0.0.1 - - [12/Sep/2019:14:26:25 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.64.0" "-"
```
**Note:** type `CTRL+C` to stop pod logs.


3. If you want to see the logs without tailing, you can run the same command without -f option

```bash
kubectl -n devteam logs http-service
 ```
 ```
 127.0.0.1 - - [12/Sep/2019:18:27:55 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.64.0" "-"
127.0.0.1 - - [12/Sep/2019:18:29:45 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.64.0" "-"
127.0.0.1 - - [12/Sep/2019:18:29:49 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.64.0" "-"
```

you can see the logs and events in azure portal

In the next example, note for the first in the list - node aks-nodepool1-, the value for **Containers** is 10, which is a rollup of the total number of containers deployed.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m3.png?st=2019-10-30T07%3A03%3A04Z&se=2022-10-31T07%3A03%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=hWIQP3MWkpMetxIL4KzacV1ygwD6qaX%2B0vRmXKefdUs%3D" alt="image-alt-text">

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m4.png?st=2019-10-30T07%3A03%3A26Z&se=2022-10-31T07%3A03%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=9fGrsGXfjjxliR2ZOWwokFkqf9DOTGaYTnTzZojIRZg%3D" alt="image-alt-text">

In the selector, select **Controllers**. 	
Here you can view the performance health of your controllers and ACI Virtual Node controllers or Virtual Node pods not connected to a controller.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m5.png?st=2019-10-30T07%3A03%3A54Z&se=2022-10-31T07%3A03%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=gw4vyjc8i4J1Y4lNn%2BBGGyRAyKxlHb895QmNmIu5aCc%3D" alt="image-alt-text">

In the selector, select **Containers**.

Here you can view the performance health of your Azure Kubernetes and Azure Container Instances containers.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m6.png?st=2019-10-30T07%3A04%3A18Z&se=2022-10-31T07%3A04%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=h5UmE%2BTgbgKbz%2FQSmvu2FZpS3TX2gj3qi67LILDdkhM%3D" alt="image-alt-text">



While viewing events, you can additionally limit the results using the **Filter** pill found to the right of the search bar. Depending on what resource you have selected, the pill lists a pod, namespace, or cluster to chose from.

To suspend autoscroll and control the behavior of the pane and allow you to manually scroll through the new data read, click on the **Scroll** option. To re-enable autoscroll, simply click the **Scroll** option again. You can also pause retrieval of log or event data by clicking on the **Pause** option and when you are ready to resume, simply click **Play**.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m7.png?st=2019-10-30T07%3A04%3A49Z&se=2022-10-31T07%3A04%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=LaAtYLlQOUPgeGJLmElQz3rboHOsBp0oeRC8YApiPpA%3D" alt="image-alt-text">


select the filter with **namespace**.
<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m8.png?st=2019-10-30T07%3A05%3A12Z&se=2022-10-31T07%3A05%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=EkqBTZNqH17WY2C17Y89N1ySIZ3QnKGn%2BjhMyVWMsho%3D" alt="image-alt-text">

select the filter **pod name**.
<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m9.png?st=2019-10-30T07%3A05%3A32Z&se=2022-10-31T07%3A05%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=CgJcnT9TDVvpY9hXbTafQPYXGiWsYRsGnG7MMMtGJ0A%3D" alt="image-alt-text">

## Search Logs to Analyze Data

Azure Monitor Logs can help you look for trends, diagnose bottlenecks, forecast, or correlate data that can help you determine whether the current cluster configuration is performing optimally. Pre-defined log searches are provided for you to immediately start using or to customize to return the information the way you want.

You can perform interactive analysis of data in the workspace by selecting the **View Kubernetes event logs** or **View container logs** option in the preview pane. The **Log Search** page appears to the right of the Azure portal page that you were on.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m10.png?st=2019-10-30T07%3A05%3A54Z&se=2022-10-31T07%3A05%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=DtsliceqNPy2bBrCBz1xAkzF2tmbWtM3Buvla3e64AY%3D" alt="image-alt-text">


The following example is a Prometheus metrics query.

Click containerLogs run the query The output will show results similar to the following

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m11.png?st=2019-10-30T07%3A06%3A19Z&se=2022-10-31T07%3A06%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=bug2nGcn6FNLTGFLkgfzK8%2FeFfU2JbL2S1YdIS9txMk%3D" alt="image-alt-text">

click heartbeat icon run the query The output will show results similar to the following.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/aks%20images/m12.png?st=2019-10-30T07%3A06%3A44Z&se=2022-10-31T07%3A06%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=KY3nAXcaFU2%2BKHNCOQkSMbYyHiJaqogZJ7%2FYn9QMjGs%3D" alt="image-alt-text">


**Conclusion:** Congratulations! You have successfully completed the  AKS Azure native monitoring and logging solution and How to view logs and events in real time ! Feel free to continue exploring or start a new lab.

<img src="https://qloudableassets.blob.core.windows.net/aks/images%20for%20aks/sp%20images%20gif/congrats-gif.gif?st=2019-08-26T06%3A22%3A30Z&se=2022-08-27T06%3A22%3A00Z&sp=rl&sv=2018-03-28&sr=b&sig=7h%2B1GwYtoaOpGYaKxe%2FrQN3dbKfhoKw%2FbPWiqstjlIc%3D" alt="image-alt-text">


Thank you for taking this training lab!
