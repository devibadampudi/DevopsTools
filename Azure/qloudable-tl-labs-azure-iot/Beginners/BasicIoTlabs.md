# Begginers Guide

## Table of Contents

- [Overview of IOT](#overview-of-iot)

- [Practice-1: Azure IoT Hub](#practice-1-azure-iot-hub)

     - [Lab-1: Creating IoT Hub Using Azure Portal and Sending data to IoT Hub using online PI Simulator](#lab-1:-creating-iot-hub-using-azure-portal-and-sending-data-to-iot-hub-using-online-pi-simulator)
     - [Lab-2: Creating IoT Hub Using Azure CLI](#lab-2:-creating-iot-hub-using-azure-cli)
     - [Lab-3: Send and receive device to cloud messages using C# code](#lab-3:-send-and-receive-device-to-cloud-messages-using-c#-code)
     - [Lab-4: Control a device connected to an IoT hub with Node.js code](#lab-4:-control-a-device-connected-to-an-iot-hub-with-node.js-code)
     - [Lab-5: Get Started with Device Twins with Node.js code](#lab-5:-get-started-with-device-twins-with-node.js-code)
     - [Lab-6: IoT Hub Manual Failover](#lab-6:-iot-hub-manual-failover)

- [Practice-2: Azure IoT Edge](#practice-2-azure-iot-edge)

     - [Lab-7: Creating an IoT Edge device in Azure IoT Hub](#lab-7:-creating-an-iot-edge-device-in-azure-iot-hub)
     - [Lab-8: Deploy a Linux machine, make it an edge device and Deploy a module](#lab-8:-deploy-a-linux-machine-and-make-it-an-edge-device-and-deploy-a-module)

- [Practice-3: IoT Hub DPS](#practice-3-iot-hub-dps)

     - [Lab-9: Create DPS Using Azure Portal and Link the IOT Hubs to DPS](#lab-9:-create-dps-using-azure-portal-and-link-the-iot-hubs-to-dps)


## Overview of IoT (Internet of Things)

### Introduction to IoT  

The Internet of Things (IoT) refers to the billions of physical devices around the world that are now connected to the internet, collecting and sharing data.

The IoT is influencing our lifestyle from the way we react to the way we behave, from air conditioners that you can control with your smartphone to smart cars providing the shortest route or our smart watch which is tracking your daily activities.

IoT is a giant network with connected devices. These devices gather and share data about how they are used and the environment in which they are operated. It's all done using sensors, sensors are embedded in every physical device. It can be your mobile phone, electrical appliances, barcode sensors, traffic lights and almost everything that you come across in day to day life. These sensors continuously emit data about the working state of the devices, but the important question is how they share this huge amount of data, and how do we put this data to our benefit.

IoT provides a common platform for all these devices to dump their data. And a common language for all the devices to communicate with each other. Data is emitted from various sensors and sent to IoT platform security. IoT platform integrates the collected data from various sources further analytics is performed on the data and valuable information is extracted as per requirement. Finally, the result is shared with other devices for better user experience Automation and improving efficiencies. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/1.jpg)

### Introduction to Azure IoT

Azure IoT is a managed cloud service that lets connected devices easily and securely interact with cloud applications and other devices. Azure IoT can support billions of devices and trillions of messages and can process and route those messages to Azure endpoints and to other devices reliably and securely. With Azure IoT, your applications can keep track of and communicate with all your devices, all the time, even when they aren’t connected.

Azure IoT makes it easy to use Azure services like IoT Hub, IoT Edge, IoT DPS, Stream Analytics, Cosmos DB, Event Hub, Notification Hub, Service bus, Time series, Data lake store and SQL DB etc., to build  IoT applications that gather, process, analyze and act on data generated by connected devices, without having any infrastructure management.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/2.png)

### Azure IoT Services

Below are few listed Azure IoT Services.

  * Azure IoT Hub

  *	Azure IoT Edge

  *	IoT Hub DPS

  * Stream Analytics

  * Cosmos DB

  * Event Hub

  * Notification Hub

  * Azure Service Bus

  * Time Series Insights

  * Azure Data Lake store

  *	SQL DB 

  * Web app

## Lab-1: Creating IoT Hub Using Azure Portal and Sending data to IoT Hub using online PI Simulator

### Introduction to Azure IoT Hub

Azure IoT Hub is a managed service that enables millions of IoT devices and solutions to have bidirectional communication between them in the most scalable, reliable and secure manner. It is Cloud-based Platform as a service that allows multiple users to access single server.

IoT Hub supports communications both ways i.e., device to the cloud and cloud to the device. IoT Hub monitoring helps maintaining the health of the solution by tracking events like device creation, device failures, and device connections.

Azure IoT Hub is known for the most reliable and secure bi-communication between device-to-cloud and cloud-to-device.

1. IoT Hub maintains Device twins on each device connected using which one can store, synchronize, and query the device’s metadata and state information.

2. Per-device authentication is provided on each device by creating a security key in a common place called IoT Hub identity registry

3. IoT Hub defines message routes to send device-to-cloud messages.

**In this Lab you will Learn**

 **Step-1:** Creating IoT Hub using Azure Portal

 **Step-2:** Creating devices on Azure IoT Hub

 **Step-3:** Sending data to IoT Hub using online PI simulator

### Step-1: Creating IoT Hub using Azure Portal

This step describes how to create an IoT hub using the Azure Portal. 

1.	Go to the **Azure Portal** and provide your credentials for login.

2.	Click **+Create a resource**, then search for IoT Hub in search box of Marketplace and select the **IoT Hub** from the list.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/3.png)

Click **Create**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/4.png)

Then you will see the below screen, fill all the required fields.

**Subscription:** Select the subscription in which you want to create your IoT hub.

**Resource Group:** Here you can either create a new Resource Group or can use an existing one. For creating a new Resource Group, select “Create new” and provide the Resource Group name. For using an existing Resource Group, select “Use existing” and pick the Resource Group from the dropdown list.

**Region:** Select the region nearest to your location to locate your IoT Hub. 

**IoTHub Name**:Enter globally unique name for your IoT Hub. If the name you provided is available, then a green check mark will appear.

Click **Next: Size and scale** to proceed further with creating IoT hub.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/5.png)

You can take the defaults by just clicking **Review + create** at the bottom.

**Pricing and scale tier:** You can select from different tiers depending on the features and messages you want to send through your solution per day. You can use free tier for testing and evaluation, which allows 500 devices to be connected to the IoT hub with the limit of 8,000 messages per day. For each Azure Subscription we can have only one free tier.

*Basic and Standard Tier:*
For IoT solution which require only Uni-directional communication from devices to the cloud, then you can use Basic Tier. Standard tier implements all the features, and it is for IoT solution which require bi-directional communication. Both tiers offer the same security and authentication features.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/6.png)

Click **Review + create**. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/7.png)

Click **Create**, which will take few minutes for IoT Hub creation.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/8.png)

After successful deployment you can see the Deployment succeeded notification as shown like below screen.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/9.png)

### Step-2: Creating devices on Azure IoT Hub

This Step describes how to create a device in existing IoT Hub. A device cannot connect to IoT Hub unless it has an entry in the identity registry.

In IoT Hub navigation menu, open **IoT Devices**, then select **Add** to register a new device in your IoT Hub.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/10.png)

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/11.png)

Provide any user defined name for new device, such as **device-1**, and select **Save**. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/12.png)

This will create a new device identity in IoT hub.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/13.png)

After the device is created, open the device from the list in the **IoT devices** pane. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/14.png)

Copy the **Connection string---primary key** and save it somewhere, this will be used later.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/15.png)

### Step-3: Sending data to IoT Hub using online PI simulator

This step describes how to send data to IoT Hub using online PI simulator and learn the basics of working with Raspberry Pi online simulator and then how to seamlessly connect the Pi simulator to the cloud by using Azure IoT Hub.

Click on below link to launch Raspberry Pi online simulator.

https://azure-samples.github.io/raspberry-pi-web-simulator/#GetStarted

In code editor window, make sure you are working on the default sample application. Remove the placeholder and update the Azure IoT Hub connection string value of “connectionString” variable.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/27.png)

Select **Run** or type “npm start” to run the application.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/28.png)

Once the Simulator start running, it shows below output of the sensor data and the messages that are sent to connected IoT Hub. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/29.png)

Messages will start flowing into IoT Hub, now check the messages in IoT Hub.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/30.png)

## Lab-2: Creating IoT Hub Using Azure CLI

**In this Lab you will Learn**

 **Step-1:** Open Azure Cloud Shell

 **Step-2:** Creating IoT Hub using Azure CLI

 **Step-3:** Register or Create a new Azure IoT device with Azure CLI

### Step-1: Open Azure Cloud Shell

Go to Azure Portal and Login with your microsoft Azure credentials.

Click on the **Cloud Shell** button on the menu in the upper-right corner of the Azure portal.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/16.png)

In cloud shell we can use Bash or PowerShell.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/17.png)

If PowerShell is selected instead of Bash, you need to Sign in and set their Azure account.

***Note:*** *If you are running Azure CLI locally instead of using Cloud Shell, then as well you need to sign in to your Azure account.*                                                                           
Run the below command to login.

***Command:***  `az login`

The console will show instructions to authenticate using the unique code, use the code to sign in to Azure account through a web browser.

If Bash is selected, then just type **az** to use Azure CLI.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/18.png)

### Step-2: Creating IoT Hub using Azure CLI

Use the below Azure CLI command for creating a Resource Group and then adding an IoT Hub.

***Syntax:*** `az group create --name {your resource group name} --location westus`

***Ex:*** `az group create --name Az-IoT-Rg --location westus`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/19.png)

The Resource Group in above example is created in the West US location. The available locations listed can be viewed by running below command.

***Command:*** `az account list-locations -o table`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/20.png)

Run the below command to create an IoT Hub in the earlier created Resource Group.

***Note:*** *Use a globally unique name for IoT Hub.*

***Syntax:*** `az iot hub create --name {your iot hub name} --resource-group {your resource group name} --sku S1`

***Ex:*** `az iot hub create --name hub2604 --resource-group Az-IoT-Rg --sku S1`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/21.png)

Verify the created IoT Hub in Azure portal.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/22.png)

### Step-3: Register or Create a new Azure IoT device with Azure CLI

***Note:*** *Run below command before creating device to add az extension.*

***Command:*** `az extension add --name azure-cli-iot-ext`

Use the below command to create a new device identity in the IoT hub.

***Syntax:*** `az iot hub device-identity create --hub-name YourIoTHubName --device-id MyNodeDevice`

***Ex:*** `az iot hub device-identity create --hub-name hub2604 --device-id device-1`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/23.png)

To make edge-enabled = true use below command.

***Syntax:*** `az iot hub device-identity create –hub-name <hubname> --device-id <device id> --edge-enabled`

***Ex:*** `az iot hub device-identity create --hub-name hub2604 --device-id device-2 --edge-enabled`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/24.png)

Use the below command to retrieve the connection string for a single device.

***Syntax:*** `az iot hub device-identity show-connection-string --device-id [device id] --hub-name [hub name]`

***Ex:*** `az iot hub device-identity show-connection-string --device-id device-2 --hub-name hub2604`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/25.png)

Delete resource group using below command.

***Syntax:*** `az group delete --name [Resource group name]`

***Ex:*** `az group delete --name Az-IoT-Rg`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/26.png)

## Lab-3: Send and receive device to cloud messages using C# code

IoT Hub is an Azure service that allows to ingest high volumes of telemetry data from connected IoT devices into the cloud for storage or processing. We send telemetry data from a simulated device application via IoT Hub to a back-end application for processing.

Here we use two pre-written C# applications, one to send the telemetry data and another to read the telemetry from the IoT Hub. We need to create an IoT hub and register a device with the hub before running the applications.

**In this Lab you will Learn**

**Step-1:** Create or Register a Device in IoT Hub

**Step-2:** Send simulated Data to IoTHub using C# code

**Step-3:** Read Simulated Data from IoT Hub using C# code

**Prerequisites**

The two sample applications are written using C#, for which .NET Core SDK 2.1.0 or greater on development machine is needed.

Verify the current version of C# on development machine using the below command.

***Command:*** `dotnet --version`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/31.png)

Execute the below command for adding the Microsoft Azure IoT Extension from Azure CLI to Cloud Shell instance. The IoT Extension adds IoT Hub, IoT Edge, and IoT Device Provisioning Service (DPS) specific commands to Azure CLI.

***Syntax:*** `az extension add --name <name of IoT Extension>`

***Ex:*** `az extension add --name azure-cli-iot-ext`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/32.png)

Download the sample C# project from below link and extract the ZIP archive.

URL : https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/AppCode/azure-iot-samples-csharp-master.zip

### Step-1: Create or Register a Device in IoT Hub

We should register a device on IoT Hub before it can be connected. Azure Cloud Shell can be used to create a simulated device.

1. Execute the below command in Azure Cloud Shell to create the device identity.

***Syntax:*** `az iot hub device-identity create --hub-name <IoTHubName> --device-id <DotnetDeviceName>`

***Ex:*** `az iot hub device-identity create --hub-name aziothubt1 --device-id device1`

***Note:*** *if you want to change the device name(device1) then you also need to change in the sample application before you run it.*

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/33.png)

device connection string for the device you to get the just created in IoT Hub, execute the below command.

***Syntax:*** `az iot hub device-identity show-connection-string –hub-name <IoTHubName> --device-id <DotNetDeviceName> --output table`

***Ex:*** `az iot hub device-identity show-connection-string --hub-name aziothub2504 --device-id device1 --output table`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/34.png)

***Note:*** *Copy the device connection string and save it to use later.*

2. To enable back-end application for connecting and retrieving the messages to the created IoT Hub, we required the following.

  * Event Hubs-compatible endpoint

  *	Event Hubs-compatible path

  * IoTHubowner primary key

By using below commands, we can retrieve these values from the created IoT hub.

Update the IoT Hub name aziothub2504 with your IoT Hub name

 ***Syntax:***

`az iot hub show --query properties.eventHubEndpoints.events.endpoint --name <IoTHubName>` 

`az iot hub show --query properties.eventHubEndpoints.events.path --name <IoTHubName>`

`az iot hub policy show --name iothubowner --query primaryKey --hub-name <IoTHubName>` 

***Ex:***

`az iot hub show --query properties.eventHubEndpoints.events.endpoint --name aziothub2504`

`az iot hub show --query properties.eventHubEndpoints.events.path --name aziothub2504`

`az iot hub policy show --name iothubowner --query primaryKey --hub-name aziothub2504`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/35.png)

***Note:*** *Save these three values, which we will use later.*

If you use any special device name instead of device1 you have to do the below changes in application code.

1. In your local system, navigate to the root folder of the sample C# application which you downloaded and extract before.Go to that extract C# application folder then navigate to the iot-hub\Quickstarts\back-end-application.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/36.png)

2. Click on that folder and open the BackEndApplication.cs file from text editior update the device1 with your device name in that file and save.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/37.png)

### Step-2: Send simulated Data to IoTHub

The simulated device application should be connected to a device-specific endpoint on your IoT hub and sends simulated temperature and humidity telemetry.

1.	In your local system, navigate to the root folder of the sample C# application whisch you downloaded and extract before.Go to that extract C# application folder then navigate to the iot-hub\Quickstarts\simulated-device folder.

2.	Click on simulated-device folder and open the SimulatedDevice.js file in any text editor.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/38.png)

3. Update the value of the connectionstring variable with the device connection string you made a note before then save the SimulatedDevice.js file

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/39.png)

4.	In the local command prompt go to the path of C# application code folder “azure-iot-samples-csharp-master\azure-iot-samples-csharp-master\iot-hub\Quickstarts\simulated-device” and run the below commands to install the required libraries and run the simulated device application.

***Command:*** `dotnet restore`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/40.png)

5.	Then enter the below command to build and run the simulated device application

***Command:*** `dotnet run`

The below screen shows the output as the simulated device application sends telemetry to IoT hub.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/41.png)

Don’t stop the sending data to simulated-device, simultaneously we must read the simulated data.

### Step-3: Read Simulated Data from IoT Hub

The server-side Events end point is getting connected by the back-end application of created IoT Hub. The simulated device sends the device-to-cloud messages to the application. The device-to-cloud messages are received and processed by IoT Hub back-end application which usually run in the cloud.

1. In local terminal, open the root folder of the sample C# project and then navigate to the iot-hub\Quickstarts folder.

2. Click on the read-d2c-messages folder and open the ReadDeviceToCloudMessages.cs file in any text editor.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/42.png)

3. Update the s_eventHubsCompatibleEndpoint, s_eventHubsCompatiblePath, s_iotHubSasKey variable values with the values which you note before while run the commands in cloud shell and save the changes to the file.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/43.png)

4. Navigate to the path of C# application code “azure-iot-samples-csharp-master\azure-iot-samples-csharp-master\iot-hub\Quickstarts\read-d2c-messages”, execute the below command to install the required libraries for the back-end application.

***Command:*** `dotnet restore`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/44.png)

5. Execute the below command to build and run the back-end application.

***Command:*** `dotnet run`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/45.png)

The simulated device sends telemetry data to the back-end application to the hub as shown in the below output screen.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/46.png)

## Lab-4: Control a device connected to an IoT hub with Node.js code

IoT Hub is an Azure service which allows to intake high volume of telemetry to cloud for storage or processing from IoT Devices. The direct method is used to control a simulated device and remotely change the behavior of a device connected to IoT Hub.

Here we use two node.js applications.

* Simulated device application

* Back-end device application

* The calls made from a back-end application through a direct method, will in turn be responded by a simulated device application. This application connects to a device-specific endpoint on IoT Hub for receiving the direct method calls.

* The direct method call is made by back-end application on the simulated device. The back-end application connects to service-side endpoint on IoT Hub for calling the direct method on a simulated device.

**In this Lab you will Learn**

**Step-1:** Create a device in IoT Hub

**Step-2:** Listen for direct method calls from IoT Hub

**Step-3:** Call the direct method from device

**Prerequisites of applications**

The two applications which we are using in the lab are written using Node.js, for which Node.js v4.x.x or later version is to be there on development machine.

To verify the current version of Node.js, execute the below command.

***Command:*** `node –version`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/47.png)

Microsoft Azure IoT Extension can be added to Azure CLI by executing the below command in the cloud Shell instance, which will add IoT Hub, IoT Edge, and IoT Device Provisioning Service specific commands to it.

Select the **Cloud Shell** button on the menu in the upper-right corner of the azure portal.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/48.png)

***Command:*** `az extension add –name azure-cli-iot-ext`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/49.png)

The sample Node.js applications code can be downloaded from below link.

URL:https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/AppCode/azure-iot-samples-node-master.zip

### Step-1: Create a device in IoT Hub

A device should be registered along with your IoT hub before it will connect. during this lab, you employ the Azure Cloud Shell to create a simulated device.

Run the below command in Azure Cloud Shell to create the device identity in your IoT Hub.

Replace IoT Hub in the below commands with the name you used for your IoT hub.

The name of the device you're creating in IoT Hub. Use device1 as given in the commands. If you decide on a special name for your device, you would like to use that name throughout the lab.

***Syntax:*** `az iot hub device-identity create --hub-name <IoTHubName> --device-id <DotnetDeviceName>`

***Ex:*** `az iot hub device-identity create --hub-name aziothubt1 --device-id device1`

***Note:*** `if you want to change the device name(device1) then you also need to change in the sample application before you run it.`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/50.png)

Run the below commands in Azure Cloud Shell to get the device connection string for the device you just created in IoT Hub.

***Syntax:*** `az iot hub device-identity show-connection-string –hub-name <IoTHubName> --device-id <DotNetDeviceName> --output table`

***Ex:*** `az iot hub device-identity show-connection-string --hub-name aziothub2504 --device-id device1 --output table`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/51.png)

Note down the device connection string in notepad we will use it later.

you also want IoT Hub connection string to modify the back-end application to attach to your IoT hub and retrieve the messages. the subsequent command retrieves the connection string for your IoT hub.

***Syntax:*** `az iot hub show-connection-string --name <IoTHubName> --output table`

***Ex:*** `az iot hub show-connection-string --name aziothub2504 --output table`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/52.png)

Note down the IoT Hub connection string, the IoT Hub connection string is totally different from the device connection string.

If you use any special device name instead of device1 you have to do the below changes in application code.

1. In your local system, navigate to the root folder of the sample node.js application which you downloaded and extract before.Go to that extract node.js application folder then navigate to the iot-hub\Quickstarts\back-end-application.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/53.png)

2. Click on that folder and open the BackEndApplication.cs file from text editior update the device1 with your device name in that file and save.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/54.png)

### Step-2: Listen for direct method calls from IoT Hub

The device-specific endpoint on IoT hub is connected by simulated device application, which sends simulated measuring and listens for direct method calls. The interval at which telemetry is sent by simulated device, can be changed by the direct method call from the IoT Hub and the simulated device responds back with an acknowledgement to IoT Hub once the direct method is executed.

From the command prompt, go to the root folder of the sample Node.js project, which we downloaded earlier. 

Now go to IoT Hub -> QuickStarts->simulated-device-2 folder.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/55.png)

Open “SimulatedDevice.js” file in any text editor from “simulated-device-2”

The **connectionString** variable value need to be changed with the device connection string, which we saved earlier and save the SimulatedDevice.js file.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/56.png)

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/57.png)

In the command prompt, navigate to the path of node.js application code 
“azure-iot-samples-node-master\azure-iot-samples-node-master\iot-hub\Quickstarts\simulated-device-2”. 

Execute the below commands to install the needed libraries and run the simulated device application.

***Command:*** `npm install`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/58.png)

***Command:*** `node SimulatedDevice.js`

The simulated device application sends telemetry to IoT Hub as shown in below screen.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/59.png)

***Note:*** *Run the back-end-application simultaneously while sending data to simulated-device-2.*

### Step-3: Call the direct method from device

A service-side endpoint on IoT Hub is connected by the back-end application. An IoT Hub back-end application usually runs in the cloud, which makes a direct method calls to a device through IoT Hub and listens for acknowledgements.

In local command prompt and go to the root folder of the sample Node.js project and navigate to iot-hub ->Quickstarts -> **back-end-application** folder.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/60.png)

Open the **BackEndApplication.js** file in any text editor from the back-end-application folder

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/61.png)

The “connectionString” variable value need to be changed with the service connection string, which we saved earlier and save the **BackEndApplication.js** file.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/62.png)

To install the required libraries and run the back-end application, execute the below command in local command prompt.

***Command:*** `npm install`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/63.png)

***Command:*** `node BackEndApplication.js`

The back-end application makes direct method call to the device and listens an acknowledgement is shown in the below screen.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/64.png)

Now we can see a message in the console window running the simulated device which we sent before and the rate at which it sends messages changes.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/65.png)

## Lab-5: Get Started with Device Twins with Node.js code

The device twin is a JSON formatted document that describes the metadata, properties of any device created within IoT Hub. It describes the individual device specific information. It stores the device state information including metadata, configurations and conditions.

**Benefits:**

*	Device twins are used to store device metadata in the cloud.

*	The current state information like available capabilities and conditions is reported from device application.

*	In long-running workflows device-twin is used to synchronize the state between device application and back-end application.

* Device twin used for querying device meta data, configuration or state.

**In this Lab you will Learn**

**Step-1:** Create the service app

**Step-2:** Create the device app

**Step-3:** Run the device app

Create IoT Hub using Azure Portal and copy the IoT Hub Connection string to use later.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/66.png)

Create Device in IoT Hub and copy the device primary key connection string. This device connection string is used by the device app to connect to your IoT Hub as a device.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/67.png)

### Step-1: Create the service app

In this lab, we create a Node.js console application that adds location metadata to the device twin associated with device id (device-1). The device twins of the IoT Hub selecting the devices located in the same region and the one that is reporting a cellular connection is queried by this console application.

1.	Open command prompt.

2.	Create a new empty folder called **addtagsandqueryapp**.

3.	In that create a new package.json file using the below command. 

***Command:*** `npm init`

4.	Accept all the defaults by pressing enter.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/68.png)

To install the **azure-iothub** package, execute the below command under addtagsandueryapp folder in the command prompt.

***Command:*** `npm install azure-iothub --save`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/69.png)

Create a new AddTagsAndQuery.js file in the addtagsandqueryapp folder using any text editor.

Update the below code to the AddTagsAndQuery.js file and replace the {iot hub connection string} with the IoT Hub connection string we copied earlier.

```
'use strict';
     var iothub = require('azure-iothub');
     var connectionString = '{iot hub connection string}';
     var registry = iothub.Registry.fromConnectionString(connectionString);

     registry.getTwin('myDeviceId', function(err, twin){
         if (err) {
             console.error(err.constructor.name + ': ' + err.message);
         } else {
             var patch = {
                 tags: {
                     location: {
                         region: 'US',
                         plant: 'Redmond43'
                   }
                 }
             };

             twin.update(patch, function(err) {
               if (err) {
                 console.error('Could not update twin: ' + err.constructor.name + ': ' + err.message);
               } else {
                 console.log(twin.deviceId + ' twin updated successfully');
                 queryTwins();
               }
             });
         }
     });
```

The **Registry** object exposes all the methods required to interact with device twins from the service. The previous code first initializes the **Registry** object, then retrieves the device twin for **device-1**, and finally updates its tags with the desired location information.

After updating the tags, it calls the **queryTwins** function.

Add the below code at the end of **AddTagsAndQuery.js** to implement the **queryTwins** function.

```
var queryTwins = function() {
         var query = registry.createQuery("SELECT * FROM devices WHERE tags.location.plant = 'Redmond43'", 100);
         query.nextAsTwin(function(err, results) {
             if (err) {
                 console.error('Failed to fetch the results: ' + err.message);
             } else {
                 console.log("Devices in Redmond43: " + results.map(function(twin) {return twin.deviceId}).join(','));
             }
         });

         query = registry.createQuery("SELECT * FROM devices WHERE tags.location.plant = 'Redmond43' AND properties.reported.connectivity.type = 'cellular'", 100);
         query.nextAsTwin(function(err, results) {
             if (err) {
                 console.error('Failed to fetch the results: ' + err.message);
             } else {
                 console.log("Devices in Redmond43 using cellular network: " + results.map(function(twin) {return twin.deviceId}).join(','));
             }
         });
     };
```

Run the application with below command

***Command:*** `node AddTagsAndQuery.js`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/70.png)

### Step-2: Create the device app

In this lab, you also create a Node.js console app that connects to your hub as device-1 and then updates its device twin's reported properties to contain the information that it is connected using a cellular network.

Create a new empty folder called **reportconnectivity**. In the **reportconnectivity**folder, create a new package.json file using the below command in your command prompt. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/71.png)

***Command: npm init***

Accept all the defaults:

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/72.png)

In your command prompt in the **reportconnectivity** folder, run the below command to install the **azure-iot-device**, and **azure-iot-device-mqtt** package

***Command: npm install azure-iot-device azure-iot-device-mqtt –save***

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/73.png)

Using a text editor, create a new **ReportConnectivity.js** file in the **reportconnectivity** folder.

Add the following code to the **ReportConnectivity.js** file and replace the **{device connection string}** placeholder with the device connection string you copied when you created the **device-1** device identity.

```
'use strict';
    var Client = require('azure-iot-device').Client;
    var Protocol = require('azure-iot-device-mqtt').Mqtt;

    var connectionString = '{device connection string}';
    var client = Client.fromConnectionString(connectionString, Protocol);

    client.open(function(err) {
    if (err) {
        console.error('could not open IotHub client');
    }  else {
        console.log('client opened');

        client.getTwin(function(err, twin) {
        if (err) {
            console.error('could not get twin');
        } else {
            var patch = {
                connectivity: {
                    type: 'cellular'
                }
            };

            twin.properties.reported.update(patch, function(err) {
                if (err) {
                    console.error('could not update twin');
                } else {
                    console.log('twin state reported');
                    process.exit();
                }
            });
        }
        });
    }
    });
```

Run the device app

***Command:*** `node ReportConnectivity.js`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/74.png)

You should see the message **twin state reported**.

Now that the device reported its connectivity information, it should appear in both queries. Go back in the **addtagsandqueryapp** folder and run the queries again

***Command:*** `node AddTagsAndQuery.js`

This time device-1 should appear in both query results.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/75.png)

## Lab-6: Azure IoT hub manual failover

Manual failover is a feature of an IoT Hub service which helps for business continuity and disaster recovery if experiencing any downtime or region failover by performing failover of an IoT Hub operations from a primary region to the corresponding Azure geo-paired region. 

Below are the steps to perform manual failover of an Azure IoT Hub.

* Create an IoT hub using Azure portal in the right, supported region.

* Perform IoT Hub failover.

* Check the status of the hub running in the secondary location.

**In this lab you will learn**

**Step-1:** Perform a IoT Hub manual failover

**Step-2:** Status of Hub running in the secondary location

**Pre-requisites**

1. Create an IoT hub using Azure Portal

*Refer Lab-1 for creating an IoT Hub.*

### Step-1: Perform a manual failover

Note that for an IoT Hub, there is a limit of two failovers and two failbacks per day.

Navigate to **Azure Portal >Resource group > select your IoT Hub >**click **Manual failover (preview)**. If the IoT Hub is not set up in a valid region, the manual failover option will be disabled.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/76.png)

On the same page, we can notice the **IoT Hub Primary Location** and the **IoT Hub Secondary Location.** The primary location is set to the location you specified when you created the IoT hub, and the secondary location is the Azure geo-paired region that is paired to the primary location. You cannot change the geo-paired region values. For example, the primary location is **westus2** and the geo-paired region of the secondary location is **West Central US**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/77.png)

Click on **Initiate failover**. You see the **Confirm manual failover** pane. Fill in the name of your IoT hub to confirm the manual failover once you see the Confirm manual failover pane. Click on **OK**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/78.png)

View the progress status of manual failover when clicked **OK**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/79.png)

### Step-2: Status of Hub running in the secondary location

Once the failover is done, the primary and secondary regions on the Manual Failover page are changed and the Hub is active again. 

In this example, the primary location is now West Central US and the secondary location is westus2.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/80.png)

## Lab-7: Creating an IoT Edge device in Azure IoT Hub

### Overview of Azure IoT Edge

Azure IoT Edge is a service meant to work on Azure IoT hub for deploying the workloads on cloud, services. Furthermore, IoT Edge can also be used in running data analytics on the device, rather on cloud to share a part of the workload across and therefore less traffic transmission to the cloud, resulting in better response time for all status changes on the devices.

In this lab you will learn about

**Step-1:** Creating an IoT Hub.

**Step-2:** Registering an IoT Edge device in your IoT hub.

**Step-3:** Deploying a Linux machine and make it an edge device

**Step-4:** Deploying Modules and learn how to create routes

### Step-1: Creating an IoT Hub.

Login to the **Azure Portal**.

Choose **+Create a resource**, then search for IoT Hub in search box and Select **IoT Hub**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/81.png)

Click on **Create**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/82.png)

Fill in all the fields with required data on the form for creating the IoT Hub.

**Subscription**: Select the subscription to deploy your IoT hub.

**Resource Group**: You can create a new resource group or use an existing one. To create a new one, click on +**“Create new”** and fill in the text box with a name for your IoT Hub. To use an existing resource group, click **“Use existing”** and select the resource group from the dropdown. 

**Region**: Select the region and location to deploy the IoT Hub, from the dropdown list.

**IoT Hub Name**: Fill in the text box with appropriate name for the IoT Hub you’ll be creating.

**Note**: The name of the IoT Hub must be globally unique. You can check if the name you entered is available from the “Green validation mark” beside the text box.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/83.png)

Click on **Next** to proceed to **Size and scale** options.

Leave all the fields to their defaults and click on **Review + Create** button at the bottom.

**Pricing and scale tier**: Here, you’ll get to choose a matching slab, depending on your usage such as the number of messages, your application transits daily. For this lab, we’ll go ahead with a free tier, intended for testing and evaluation purposes. This plan can support 500 connected devices and can exchange up to 8,000 messages each day. 

***Note:** *Each Azure Subscription has a cap of 1 number of IoT hub on free tier.*

**IoT Hub units**: The number of messages allowed per unit/day is defined as per the pricing plan.

Example: S1. Standard tier supports 7,00,000 messages / unit a day.

***Advanced / Device-to-cloud partitions***: This property relates the device-to-cloud messages to the number of simultaneous readers of the messages. Mostly, IoT hub only needs four partitions.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/84.png)

Click **Review + create** to review your choices.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/85.png)

Click on **“Create”** to create your new IoT hub. The process takes a few minutes.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/86.png)

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/87.png)

### Step-2: Registering an IoT Edge device in your IoT hub.

The IoT Edge device requires a device entity to establish connection to the IoT hub. The identity of the device lives on the cloud and a unique device connection string can be used to associate a physical device. You can create one by following the steps below.

Go to **Resource group -> IoT Hub -> IoT Edge** -> click on **“Add an IoT Edge device”**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/88.png)

Enter value for the **Device name** and click on **Save**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/89.png)

The created device will be displayed as shown in the screenshot below. Proceed to click on the created device.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/90.png)

**Copy** the **Connection string** (primary key which will be used to configure the IoT Edge runtime).

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/91.png)

### Step-3: Deploying a Linux machine and make it an edge device

#### Deploy Ubuntu VM using Azure Portal

Click on **+ Create a resource** on the upper left corner of your Azure portal and search for **Ubuntu**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/92.png)

On the **Basics** tab, under the **Project details**, make sure the correct subscription is selected and then click on **Create new**.

On the next step, enter a value for name of VM, choose appropriate ones for available dropdown’s and click on **OK**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/93.png)

Select **VM size**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/94.png)

Then Select authentication type as Password and give username and Password for VM to login then click on **Next:Disks**

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/95.png)

Choose **OS disk type**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/96.png)

Leave rest of all fields to their defaults and then click on **Create**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/97.png)

Navigate to the **Resource groups** and select the VM, you just created. Click on the **Connect** to get **ssh** command to connect to the VM.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/98.png)

**Copy** the **SSH** command.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/99.png)

Click on **Cloud shell** in the portal.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/100.png)

Make sure you select **Bash shell**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/101.png)

#### Configure the IoT Edge device

Start the Azure IoT Edge runtime on your IoT Edge device.

You’ll be required to provide a device connection string in the process of configuring Runtime on the device. Use the string retrieved from the Azure CLI, which associates your physical device with IoT Edge device identity on Azure.

**Set the connection string on the IoT Edge device**

If you're using the Azure IoT Edge on Ubuntu virtual machine as described in the prerequisites, then your device already has the IoT Edge runtime installed. You will just need to configure your device with the device connection string that you retrieved in the previous section.

Run the following command, replacing **{device_connection_string}** with the string retrieved.

***Syntax:***

`az vm run-command invoke -g <Resource group name> -n <VM name> --command-id RunShellScript --script "/etc/iotedge/configedge.sh '<device_connection_string>'`

***Ex:*** `az vm run-command invoke -g Az-IoTedge-Rg -n Edgevm --command-id RunShellScript --script "/etc/iotedge/configedge.sh 'HostName=edgehub30.azure-devices.net;DeviceId=device-1;SharedAccessKey=8L6UKj9xhSPby1MCs1Rk1bnfBrhub4vnltJnebzFo14='`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/102.png)

***Note:*** *If you're running IoT Edge on your local machine, you will need to install the IoT Edge runtime and its prerequisites on your device.*

#### Login to Ubuntu VM

Go back to Cloud Shell and paste the copied ssh command to login to Ubuntu VM.

Enter the password you used to create the VM, when prompted and hit on **Enter**.

On a successful authentication, you’ll be logged in on to your VM.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/103.png)

#### Install the Azure IoT Edge runtime on Linux machine

Follow the steps below to install the Azure IoT Edge runtime on your Ubuntu Linux x64 (Intel/AMD) IoT Edge device. 

**Register Microsoft key and software repository feed**

***Command:*** `curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list > ./microsoft-prod.list`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/104.png)

***Command:*** `sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/105.png)

***Command:*** `curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg`

***Command:*** `sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/106.png)

**Container runtime Installation**

***Command:*** `sudo apt-get update`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/107.png)

***Command:*** `sudo apt-get install moby-engine`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/108.png)

***Command:*** `sudo apt-get install moby-cli`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/109.png)

**Installation of Azure IoT Edge Security Daemon**:

***Command:*** `sudo apt-get update`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/110.png)

***Command:*** `sudo apt-get install iotedge`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/111.png)

**Azure IoT Edge Security Daemon Configuration**

***Command:*** `sudo nano /etc/iotedge/config.yaml`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/112.png)

Update the device connection string in config.yaml file.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/113.png)

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/114.png)

***Command:*** `sudo systemctl restart iotedge`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/115.png)

**Verify successful installation**

***Command:*** `systemctl status iotedge`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/116.png)

***Command:*** `sudo iotedge list`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/117.png)

### Step-4: Deploying Modules and learn how to create routes

You can manage your Azure IoT Edge device from the cloud portal, to deploy a module that will send telemetry data to IoT Hub. 

Go to **“Azure portal”**, search for the **“Simulated Temperature Sensor”** and click on the Market place result for the same.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/118.png)

Select an IoT Edge device to receive this module. On the **“Target Devices for IoT Edge Module”** page, provide the following information:

* **Subscription:** Select the same subscription on which IoT hub, you just created is residing. 

* **IoT Hub:** Select the name of the IoT hub.

* **IoT Edge Device Name:**Select **“Find Device”** to choose from a list of IoT Edge devices in your IoT hub.

Click on **Create**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/119.png)

Click on **Next**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/120.png)

Click on **Next**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/121.png)

Click on **Submit**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/122.png)

Go to the device details page and scroll down to find the **Modules** section which contains, **$edgeAgent**, **$edgeHub**, and **SimulatedTemperatureSensor**. 

***Note:** *If one or more of the modules are listed as specified in deployment, but not reported by the device, your IoT Edge device is still starting them. Wait for few moments and click on Refresh at the top of the page.*

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/123.png)

You can check the status of **“IoT Edge modules”** in edge VM, using below command.

***Command:** `sudo iotedge list`

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/124.png)

## Lab-9: Create DPS Using Azure Portal and Link the IOT Hubs to DPS

### Introduction to DPS

For all your IoT Solutions needs, Microsoft Azure provides a rich set of integrated public cloud services. The IoT Hub Device Provisioning Service (DPS) is a helper service for IoT Hub that enables customers to provision/facilitate millions of devices in a secure and scalable manner without need of human intervention.

The Device Provisioning Service is an excellent choice for getting devices connected and configured to IoT Hub, a few of which are.

1. Zero-touch provisioning to a single IoT solution without any required hardcoding of IoT Hub connection information in the factory.

2. Automatically configuring devices based on solution-specific needs.

3. Across multiple hubs load balancing the devices.

4. Based on sales transaction data connecting devices to their owner’s IoT solution.

5. Depend upon use-case connects devices to the specific IoT solution.

6. Connecting a device to the IoT hub with the nearest geo-location.

7. Re-provisioning based on a change in the device, such as a change in ownership or location.

8. The Device Provisioning Service is flexible enough to support all those scenarios using the same basic flow.

The below section explains what goes on behind to get a device provisioned. Besides the first step which is manual, remaining all the below steps are automated.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d1.png)

1. The device registration information was added by device manufacturer to the enrollment list in the Azure portal.

2. The provisioning service endpoint set at the factory is connected by device and it passes the identifying information to the provisioning service for proving its identity. 

3. The device identity is validated by provisioning service by using the registration ID and key against the enrollment list entry using either a nonce challenge (Trusted Platform Module) or standard X.509 verification.

4. The device is registered with an IoT Hub by provisioning service and populates the device's desired twin state.

5. The provisioning service gets the device ID information from the IoT Hub.

6. The provisioning service returns the IoT hub connection information to the device, it will start sending data directly to the IoT hub.

7. The device connects to IoT hub.

8. The device gets the desired state from its device twin in IoT hub

**Pre-requisites:**

1. Create IoT Hub using Azure Portal

2. Create a device in IoT Hub

**Note:** Before you create the device provisioning service first you have to create the IoT Hub, For Creating IoT Hub refer the Lab-1 to Create Azure IoT Hub Using Azure Portal and Create a device in IoT Hub 

**In this lab you will learn**

**Step-1:** Create DPS using Azure Portal

**Step-2:** Create DPS using Azure Portal

### Step-1: Create DPS using Azure Portal

In This step we are creating the IoT hub device provisioning service using the Azure Portal. 

1. First you have to login to the azure portal with your credentials.

2. Click on +Create a resource in azure portal, then search for IoT Hub device provisioning service in search box and Click IoT Hub Device Provisioning Service in the list.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d2.png)

Then click on **Create**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d3.png)

Then we can see the first screen for creating an IoT hub device provisioning service

Fill all the fields to create DPS.

1. In the Name field give a unique name to your device provisioning service, If the name is available it will show the green check mark.

2. Select the specific subscription you want to deploy the Device Provisioning Service

3. You can create a new resource group or use an existing resource group in your portal. To create a new resource group, click on Create new and assign the name you want to use for the resource group, To use an existing resource group, click Use existing and select the resource group from the dropdown. 

4. Select the region from dropdown list, in which location you want to deploy the device provisioning service.

Then click on **Create**

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d4.png)

Click the notification button to monitor the creation of the DPS service. After the device provisioning service is successfully deployed, then click on Go to resource so that you can redirect to the DPS resource group.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d5.png)

### Step-2: Link the IoT hubs to DPS

You will add a configuration to the DPS instance, which will set the IoT hub for which devices will be provisioned.

1. Click on the resource groups button from the left-hand menu of the Azure portal. Select the resource group which you deployed the device provisioning service in the earlier section.

2. Click on the DPS service and go to overview, select Linked IoT hubs. Click on the + Add button to add the IoT hub to Device provisioning service.

3. Then it will display the below screen of the Add link to IoT hub, provide the following information to link new DPS instance to an IoT hub. 

    * Select the subscription of the IoT hub that you want to link with DPS.

    * Select the IoT hub name from the dropdown to link with the deployed Device Provisioning service.

    * In access policy, select “iothubowner” in dropdown for establishing the link between the IoT hub and Device provisioning service 

Then click on **Save**.

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d6.png)

Once you click on **Refresh** button to show Linked IoT hubs.

Now you can see the selected IoT hub, when you click on Linked IoT hubs. 

![alt text](https://github.com/sysgain/qloudable-tl-labs/raw/Azure-IoT-Labs/Beginners/images/d7.png)

